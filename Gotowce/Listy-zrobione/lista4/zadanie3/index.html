<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <style>
            #ramka {height:700px;width:700px; border:1px solid grey;margin:auto;position:relative}
            b, img {display:block;height:35px;width:35px;position: absolute;text-align:center}
            img { background-color: green;}
            div {text-align:center;margin:10px;}
            button {position:relative;margin:auto;text-align: center;}
            #reset {position: absolute;left:1%;top:1%;width: 250px;height:250px;font-size: 50px;border:1px solid black;background-color: grey;}
        </style>
    </head>
    <body>
        
        <div id="ramka"></div>
        <button id="reset">Nowa Gra</button>
        <script src="/socket.io/socket.io.js"></script>
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
        <script>
            var przesuniecie = [35, 0]; // dx dy 
            var pX;
            var pY;
            var idMoje;

            var pierwszy = true;
            var reset_button = document.getElementById('reset');

            var socket = io();

            socket.on("punktyS", function(punkty){
                pX = punkty[0];
                pY = punkty[1];
            });

            socket.on("ruch", function(gracze, id, kolor, pozycjeOgonow){   //pozycje graczy
                idMoje = id;

                $("#ramka").empty();
                for(let gracz in pozycjeOgonow){
                    if(pozycjeOgonow[gracz] != null && pozycjeOgonow[gracz] != undefined){
                        for(let ogon in pozycjeOgonow[gracz]){
                            if(pozycjeOgonow[gracz][ogon] != null && pozycjeOgonow[gracz][ogon] != undefined){
                                if(pierwszy == true){    //rysuje glowe
                                    $('#ramka').append("<b class="+gracz+" style='left:"+pozycjeOgonow[gracz][ogon][0]+"px;top:"+pozycjeOgonow[gracz][ogon][1]+"px; background-color: rgb("+kolor[gracz][0]+","+kolor[gracz][1]+","+kolor[gracz][2]+")'></b>");
                                    pierwszy = false;
                                }
                                else{                    // rysuje ogon
                                    $('#ramka').append("<b class="+gracz+" style='left:"+pozycjeOgonow[gracz][ogon][0]+"px;top:"+pozycjeOgonow[gracz][ogon][1]+"px; background-color: rgb("+kolor[gracz][0]+","+kolor[gracz][1]+","+kolor[gracz][2]+")'></b>");

                                    pozycjeOgonow[gracz] = sprawdzenie(gracze, gracz, kolor, pozycjeOgonow[gracz]);  // zaktualizuje ogon 
                                   // pozycjeOgonow[gracz].splice(0,1);
                                }
                            }
                        }
                        pozycjeOgonow[gracz].splice(0,1);  //usuwa ogon odpowiednio, ale są jakieś błędy przy dodawaniu nowej części ogona
                    }
                }
                socket.emit("ruch", pozycjeOgonow);

            });

            function sprawdzenie(gracze, gracz, kolor, pozycjaOgona){       // !tu gdzieś coś nie działa! - dlatego źle rysuje po najechaniu wężem na punkt (lub przy usuwaniu ogona w funkcji wyżej)
                if( (gracze[gracz][0] > 665 || gracze[gracz][0] < 0) || (gracze[gracz][1] > 665 || gracze[gracz][1] < 0) ) 
                    socket.emit("zatrzymaj", gracz);
                if(gracze[gracz][0] == pX && gracze[gracz][1] == pY){
                    if(gracze[gracz][2] == -35)     // sprawdza w którą strone ostatnio poruszał sie wąż i w tamtym kierunku tworzy nową głowę
                        pozycjaOgona = [ ...pozycjaOgona, [ pozycjaOgona[pozycjaOgona.length-1][0]+35,  pozycjaOgona[pozycjaOgona.length-1][1]      ] ];
                    if(gracze[gracz][2] == 35)
                        pozycjaOgona = [ ...pozycjaOgona, [ pozycjaOgona[pozycjaOgona.length-1][0]-35,  pozycjaOgona[pozycjaOgona.length-1][1]      ] ];
                    if(gracze[gracz][3] == -35)
                        pozycjaOgona = [ ...pozycjaOgona, [ pozycjaOgona[pozycjaOgona.length-1][0],     pozycjaOgona[pozycjaOgona.length-1][1]+35   ] ];
                    if(gracze[gracz][3] == 35)
                        pozycjaOgona = [ ...pozycjaOgona, [ pozycjaOgona[pozycjaOgona.length-1][0],     pozycjaOgona[pozycjaOgona.length-1][1]-35   ] ];
                    $('img').remove();
                    socket.emit("punktyK");
                }

                for(let i=0; i<$('.'+gracz).length-3; i++){ ///sprawdzenie kolizji ze SOBĄ 
                    if($("."+gracz).last().position().top == $("."+gracz).eq(i).position().top && $("."+gracz).last().position().left == $("."+gracz).eq(i).position().left){
                        socket.emit("zatrzymaj", gracz)
                    }
                }  
                //rysowanie punktu do zdobycia
                $('#ramka').append("<img style='left:"+pX+"px;top:"+pY+"px; background-color: green;'>");

                return pozycjaOgona;
            }

            var lock=1;
            $(document).keydown(function(event) {
                var a=event.keyCode;
                if(a==37 && lock!=1) {przesuniecie[0]=-35;przesuniecie[1]=0; lock=2;}   //1 strzałka w lewo
                if(a==38 && lock!=3) {przesuniecie[0]=0;przesuniecie[1]=-35; lock=4;}   //2 strzałka w górę
                if(a==39 && lock!=2) {przesuniecie[0]=35;przesuniecie[1]=0; lock=1;}    //3 strzałka w prawo
                if(a==40 && lock!=4) {przesuniecie[0]=0;przesuniecie[1]=35; lock=3;}    //4 strzałka w dół
                socket.emit("klik", przesuniecie, idMoje);
            });

            socket.on("wyczysc", ()=>{
                $("#ramka").empty();
            });
            // wysyłanie wiadomości o resecie
            reset_button.addEventListener('click', function() {
                socket.emit('reset');
            });

        </script>
    </body>
</html>
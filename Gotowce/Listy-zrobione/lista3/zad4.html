<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Zad 4 - SAPER</title>
    <style>
        table td {
            width: 30px;
            height: 30px;
            border: 1px solid gray;
            text-align: center;
        }
    </style>
</head>

<body>
    <button onclick="letsPlay();">Nowa gra</button>
    <table></table>
    <script>
        let cells = [];      // plansza
        let bombs = [];      // indexy bomb
        let found = 0;       // do zliczania odslonientych pol

        // generowanie wierszy i kolumn
        function fields(){
            let tbody = "";
            for (let i = 0; i < 10; i++){
                tbody += "<tr>";
                for (let j = 0; j < 10; j++){
                    tbody += "<td></td>";
                }
                tbody += "</tr>";
            }
            document.querySelector("table").innerHTML = tbody;
        }

        // start
        function letsPlay() {
            fields();
            cells = [];
            cells = document.querySelectorAll("td");
            bombs = [];
            found = 0;
            
            // generowanie bomb 
            for (let i = 0; i < 10; i++) {
                let losuj = true;

                while (losuj) {                                 // by sie nie powtarzaly
                    bombs[i] = Math.floor(Math.random() * cells.length);
                    if (!(cells[bombs[i]].hasAttribute("className"))) losuj = false;
                }
                // let x = -1;
                // do{
                //     x = Math.floor(Math.random() * cells.length);
                // }while(bombs.includes(x));
                // bombs[i] = x;

                cells[bombs[i]].setAttribute("className", "bomba");
                cells[bombs[i]].onclick = () => {
                    if(found > 0){
                        cells[bombs[i]].style.backgroundColor = "red";
                        alert("Bum!");                                      // umarło się
                        for(let x of bombs){
                            cells[x].style.backgroundColor = "red";
                        }
                        for(let x of cells){                                // nieklikable
                            x.onclick = "";
                        }
                    }
                    else {                                                  // pierwsze klikniecie to bomba
                        let tmp = bombs[i];
                        letsPlay();
                        cells[tmp].click(); // podszywa sie pod gracza :0
                    }
                }
            }

            // zliczanie bomb-sasiadow
            for (let i = 0; i < cells.length; i++) {
                if (!(cells[i].hasAttribute("className"))) {
                    cells[i].values = 0;
                    if (i > 10 && i % 10 != 0) if (cells[i - 11].hasAttribute("className")) cells[i].values++;    // lewy gorny
                    if (i > 9) if (cells[i - 10].hasAttribute("className")) cells[i].values++;      // gorny
                    if (i > 8 && i % 10 != 9) if (cells[i - 9].hasAttribute("className")) cells[i].values++;       // prawy gorny
                    if (i > 0 && i % 10 != 0) if (cells[i - 1].hasAttribute("className")) cells[i].values++;       // lewy
                    if (i < 99 && i % 10 != 9) if (cells[i + 1].hasAttribute("className")) cells[i].values++;      // prawy
                    if (i < 91 && i % 10 != 0) if (cells[i + 9].hasAttribute("className")) cells[i].values++;      // lewy dolny
                    if (i < 90) if (cells[i + 10].hasAttribute("className")) cells[i].values++;     // dolny
                    if (i < 89 && i % 10 != 9) if (cells[i + 11].hasAttribute("className")) cells[i].values++;     // prawy dolny
                }
                else cells[i].values = -1;  // dla bomb
            }

            // funkcja onclick
            for (let i = 0; i < cells.length; i++) {
                if (!(cells[i].hasAttribute("className"))) {
                    cells[i].onclick = () => show(i);       // wywolanie funkcji odkrywajacej
                }
            }
        }

        // funkcja odslaniajaca
        function show(i) {
            if (cells[i].showed != true) {   // dzialanie tylko dla nieodkrytego
                found++;
                cells[i].showed = true;
                if (cells[i].values == 0 && cells[i].style.backgroundColor != "#ccc") { // seria zer
                    cells[i].style.backgroundColor = "#ccc";
                    if (i > 9) if (cells[i - 10].values == 0 && cells[i - 10].style.backgroundColor != "#ccc") show(i - 10);
                    if (i > 0 && i % 10 != 0) if (cells[i - 1].values == 0 && cells[i - 1].style.backgroundColor != "#ccc") show(i - 1);
                    if (i < 99 && i % 10 != 9) if (cells[i + 1].values == 0 && cells[i + 1].style.backgroundColor != "#ccc") show(i + 1);
                    if (i < 90) if (cells[i + 10].values == 0 && cells[i + 10].style.backgroundColor != "#ccc") show(i + 10);
                }
                else if (cells[i].values != 0 && cells[i].innerHTML == "") cells[i].innerHTML = cells[i].values;
            }
            if (found == 90) {
                alert("Brawo, nic nie wybuchło!");
                letsPlay();
            }
        }

        letsPlay();
    </script>
</body>

</html>